{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <h1>Welcome back, {{ current_user.name }}!</h1>
        <p>Here's your lesson overview</p>
    </div>
    
    <div class="dashboard-stats">
        <div class="stat-card pending">
            <div class="stat-number">{{ stats.pending }}</div>
            <div class="stat-label">Pending Invoices</div>
        </div>
        <div class="stat-card paid">
            <div class="stat-number">{{ stats.paid }}</div>
            <div class="stat-label">Paid Lessons</div>
        </div>
        <div class="stat-card overdue">
            <div class="stat-number">{{ stats.overdue }}</div>
            <div class="stat-label">Overdue</div>
        </div>
        <div class="stat-card total">
            <div class="stat-number">Â£{{ "%.2f"|format(stats.total_revenue) }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
    </div>
    
    <div class="dashboard-content">
        <div class="panel">
            <h2>Add New Lesson</h2>
            <form method="POST" action="{{ url_for('add_lesson') }}" class="lesson-form">
                {{ form.hidden_tag() }}
                
                <!-- Student Information Section -->
                <fieldset style="border: 2px solid #e2e8f0; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
                    <legend style="padding: 0 0.5rem; font-weight: 600; color: #4a5568;">Student Information</legend>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.student_name.label(class="form-label") }}
                            {{ form.student_name(class="form-input", placeholder="Enter student's full name") }}
                            {% if form.student_name.errors %}
                                <div class="form-error">{{ form.student_name.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.student_email.label(class="form-label") }}
                            {{ form.student_email(class="form-input", placeholder="student@example.com") }}
                            {% if form.student_email.errors %}
                                <div class="form-error">{{ form.student_email.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>
                
                <!-- Lesson Details Section -->
                <fieldset style="border: 2px solid #e2e8f0; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
                    <legend style="padding: 0 0.5rem; font-weight: 600; color: #4a5568;">Lesson Details</legend>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.date.label(class="form-label") }}
                            {{ form.date(class="form-input", id="date") }}
                            {% if form.date.errors %}
                                <div class="form-error">{{ form.date.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.time.label(class="form-label") }}
                            {{ form.time(class="form-input") }}
                            {% if form.time.errors %}
                                <div class="form-error">{{ form.time.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.duration.label(class="form-label") }}
                            {{ form.duration(class="form-select") }}
                            {% if form.duration.errors %}
                                <div class="form-error">{{ form.duration.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.lesson_type.label(class="form-label") }}
                            {{ form.lesson_type(class="form-select") }}
                            {% if form.lesson_type.errors %}
                                <div class="form-error">{{ form.lesson_type.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.rate.label(class="form-label") }}
                            {{ form.rate(class="form-input", step="0.01", min="0") }}
                            {% if form.rate.errors %}
                                <div class="form-error">{{ form.rate.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-input", placeholder="Optional notes about the lesson") }}
                            {% if form.notes.errors %}
                                <div class="form-error">{{ form.notes.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>
                
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-primary btn-lg">Add Lesson</button>
                </div>
            </form>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <h2>Recent Lessons</h2>
                <div class="panel-actions">
                    <select id="statusFilter" class="form-select">
                        <option value="all">All Lessons</option>
                        <option value="pending">Pending Payment</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    <button class="btn btn-secondary" onclick="sendBulkReminders()">Send Reminders</button>
                </div>
            </div>
            <div id="lessonsList" class="lessons-list">
                <div class="empty-state">Loading lessons...</div>
            </div>
        </div>
    </div>
</div>

<!-- Students Management Modal -->
<div id="studentsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Students</h3>
            <button class="modal-close" onclick="closeModal('studentsModal')">&times;</button>
        </div>
        <div class="modal-body" id="studentsContent">
            <div id="studentsList">
                <!-- Students will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadLessons();
    
    // Set today's date as default
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.valueAsDate = new Date();
    }
    
    // Filter change handler
    document.getElementById('statusFilter').addEventListener('change', loadLessons);
    
    // Form validation
    const form = document.querySelector('.lesson-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const studentName = form.querySelector('input[name="student_name"]').value.trim();
            const studentEmail = form.querySelector('input[name="student_email"]').value.trim();
            const date = form.querySelector('input[name="date"]').value;
            const time = form.querySelector('input[name="time"]').value;
            const rate = form.querySelector('input[name="rate"]').value;
            
            if (!studentName || !studentEmail || !date || !time || !rate) {
                e.preventDefault();
                showNotification('Please fill in all required fields', 'error');
                return false;
            }
            
            if (!isValidEmail(studentEmail)) {
                e.preventDefault();
                showNotification('Please enter a valid email address', 'error');
                return false;
            }
        });
    }
});

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function loadLessons() {
    const filter = document.getElementById('statusFilter').value;
    const url = new URL('/api/lessons', window.location.origin);
    if (filter !== 'all') {
        url.searchParams.append('status', filter);
    }
    
    fetch(url)
        .then(response => response.json())
        .then(lessons => displayLessons(lessons))
        .catch(error => {
            console.error('Error loading lessons:', error);
            showNotification('Error loading lessons', 'error');
        });
}

function displayLessons(lessons) {
    const container = document.getElementById('lessonsList');
    
    if (lessons.length === 0) {
        container.innerHTML = '<div class="empty-state">No lessons found. Add your first lesson above!</div>';
        return;
    }
    
    container.innerHTML = lessons.map(lesson => `
        <div class="lesson-item ${lesson.status}">
            <div class="lesson-header">
                <div class="lesson-student">${lesson.student_name}</div>
                <div class="lesson-status status-${lesson.status}">${lesson.status.charAt(0).toUpperCase() + lesson.status.slice(1)}</div>
            </div>
            <div class="lesson-details">
                ð ${formatDate(lesson.date)} at ${lesson.time} | 
                â±ï¸ ${lesson.duration}h | 
                ð·ï¸ ${lesson.lesson_type} | 
                ð° Â£${lesson.total_amount.toFixed(2)}
                <br>âï¸ ${lesson.student_email}
                ${lesson.notes ? `<br>ð ${lesson.notes}` : ''}
                <br><small>ð Invoice: ${lesson.invoice_number}</small>
            </div>
            <div class="lesson-actions">
                <button class="btn btn-sm" onclick="viewInvoice(${lesson.id})">ð View Invoice</button>
                ${lesson.status === 'pending' ? 
                    `<button class="btn btn-sm btn-success" onclick="markAsPaid(${lesson.id})">â Mark Paid</button>` : ''}
                ${lesson.status === 'pending' || lesson.status === 'overdue' ? 
                    `<button class="btn btn-sm btn-warning" onclick="sendReminder(${lesson.id})">ð§ Send Reminder</button>` : ''}
                <button class="btn btn-sm btn-danger" onclick="deleteLesson(${lesson.id})">ðï¸ Delete</button>
            </div>
        </div>
    `).join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-GB');
}

function markAsPaid(lessonId) {
    if (!confirm('Mark this lesson as paid?')) return;
    
    fetch(`/api/lesson/${lessonId}/mark_paid`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadLessons();
            updateStats();
        } else {
            showNotification(data.error || 'Error updating lesson', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating lesson', 'error');
    });
}

function deleteLesson(lessonId) {
    if (!confirm('Are you sure you want to delete this lesson? This cannot be undone.')) return;
    
    fetch(`/api/lesson/${lessonId}/delete`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadLessons();
            updateStats();
        } else {
            showNotification(data.error || 'Error deleting lesson', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting lesson', 'error');
    });
}

function sendReminder(lessonId) {
    fetch(`/api/send_reminder/${lessonId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Error sending reminder', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending reminder', 'error');
    });
}

function sendBulkReminders() {
    if (!confirm('Send payment reminders to all students with unpaid lessons?')) return;
    
    fetch('/api/send_bulk_reminders', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Error sending reminders', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending reminders', 'error');
    });
}

function viewInvoice(lessonId) {
    window.open(`/invoice/${lessonId}`, '_blank');
}

function updateStats() {
    // In a production app, you'd update stats via API
    // For now, reload to get fresh stats
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}
</script>
{% endblock %}