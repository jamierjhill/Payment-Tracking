# templates/dashboard.html
{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <h1>Welcome back, {{ current_user.name }}!</h1>
        <p>Here's your lesson overview</p>
    </div>
    
    <div class="dashboard-stats">
        <div class="stat-card pending">
            <div class="stat-number">{{ stats.pending }}</div>
            <div class="stat-label">Pending Invoices</div>
        </div>
        <div class="stat-card paid">
            <div class="stat-number">{{ stats.paid }}</div>
            <div class="stat-label">Paid Lessons</div>
        </div>
        <div class="stat-card overdue">
            <div class="stat-number">{{ stats.overdue }}</div>
            <div class="stat-label">Overdue</div>
        </div>
        <div class="stat-card total">
            <div class="stat-number">¬£{{ "%.2f"|format(stats.total_revenue) }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
    </div>
    
    <div class="dashboard-content">
        <div class="panel">
            <h2>Add New Lesson</h2>
            <form method="POST" action="{{ url_for('add_lesson') }}" class="lesson-form">
                {{ form.hidden_tag() }}
                
                <!-- Quick Template Selection -->
                <div class="form-group">
                    {{ form.template.label(class="form-label") }}
                    {{ form.template(class="form-select", id="templateSelect") }}
                    <small class="form-help">Select a template to auto-fill common lesson types</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form.student_name.label(class="form-label") }}
                        {{ form.student_name(class="form-input", required=True) }}
                    </div>
                    <div class="form-group">
                        {{ form.student_email.label(class="form-label") }}
                        {{ form.student_email(class="form-input") }}
                        <small class="form-help">Optional - for sending invoices and reminders</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form.student_phone.label(class="form-label") }}
                        {{ form.student_phone(class="form-input") }}
                    </div>
                    <div class="form-group">
                        {{ form.date.label(class="form-label") }}
                        {{ form.date(class="form-input", id="lessonDate") }}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form.time.label(class="form-label") }}
                        {{ form.time(class="form-input") }}
                    </div>
                    <div class="form-group">
                        {{ form.duration.label(class="form-label") }}
                        {{ form.duration(class="form-select", id="durationSelect") }}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form.rate.label(class="form-label") }}
                        {{ form.rate(class="form-input") }}
                    </div>
                    <div class="form-group">
                        {{ form.lesson_type.label(class="form-label") }}
                        {{ form.lesson_type(class="form-select", id="lessonTypeSelect") }}
                    </div>
                </div>
                
                <div class="form-group">
                    {{ form.notes.label(class="form-label") }}
                    {{ form.notes(class="form-input", id="notesField", rows="3") }}
                </div>
                
                <button type="submit" class="btn btn-primary">Add Lesson</button>
            </form>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <h2>Recent Lessons</h2>
                <div class="panel-actions">
                    <select id="statusFilter" class="form-select">
                        <option value="all">All Lessons</option>
                        <option value="pending">Pending Payment</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    <button class="btn btn-secondary" onclick="sendBulkReminders()">Send Reminders</button>
                </div>
            </div>
            <div id="lessonsList" class="lessons-list">
                <!-- Lessons will be loaded here via JavaScript -->
            </div>
        </div>
    </div>
</div>

<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Invoice Preview</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="invoiceContent">
            <!-- Invoice content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let lessonTemplates = {};

document.addEventListener('DOMContentLoaded', function() {
    // Load lesson templates
    fetch('/api/lesson_templates')
        .then(response => response.json())
        .then(templates => {
            lessonTemplates = templates;
        })
        .catch(error => console.error('Error loading templates:', error));

    loadLessons();
    
    // Set today's date as default
    const dateInput = document.getElementById('lessonDate');
    if (dateInput) {
        dateInput.valueAsDate = new Date();
    }
    
    // Template selection handler
    document.getElementById('templateSelect').addEventListener('change', function() {
        const selectedTemplate = this.value;
        if (selectedTemplate && lessonTemplates[selectedTemplate]) {
            const template = lessonTemplates[selectedTemplate];
            
            // Fill form fields with template data
            document.getElementById('durationSelect').value = template.duration;
            document.getElementById('lessonTypeSelect').value = template.lesson_type;
            document.getElementById('notesField').value = template.notes;
            
            showNotification('Template applied successfully!', 'success');
        }
    });
    
    // Filter change handler
    document.getElementById('statusFilter').addEventListener('change', loadLessons);
});

function loadLessons() {
    const filter = document.getElementById('statusFilter').value;
    const url = new URL('/api/lessons', window.location.origin);
    if (filter !== 'all') {
        url.searchParams.append('status', filter);
    }
    
    fetch(url)
        .then(response => response.json())
        .then(lessons => displayLessons(lessons))
        .catch(error => {
            console.error('Error loading lessons:', error);
            showNotification('Error loading lessons', 'error');
        });
}

function displayLessons(lessons) {
    const container = document.getElementById('lessonsList');
    
    if (lessons.length === 0) {
        container.innerHTML = '<div class="empty-state">No lessons found.</div>';
        return;
    }
    
    container.innerHTML = lessons.map(lesson => `
        <div class="lesson-item ${lesson.status}">
            <div class="lesson-header">
                <div class="lesson-student">${lesson.student_name}</div>
                <div class="lesson-status status-${lesson.status}">${lesson.status}</div>
            </div>
            <div class="lesson-details">
                üìÖ ${formatDate(lesson.date)} at ${lesson.time} | 
                ‚è±Ô∏è ${lesson.duration}h | 
                üè∑Ô∏è ${lesson.lesson_type} | 
                üí∞ ¬£${lesson.total_amount.toFixed(2)}
                <br>‚úâÔ∏è ${lesson.student_email}
                ${lesson.student_phone ? `<br>üì± ${lesson.student_phone}` : ''}
                ${lesson.notes ? `<br>üìù ${lesson.notes}` : ''}
            </div>
            <div class="lesson-actions">
                <button class="btn btn-sm" onclick="viewInvoice(${lesson.id})">View Invoice</button>
                ${lesson.status === 'pending' || lesson.status === 'overdue' ? 
                    `<button class="btn btn-sm btn-success" onclick="markAsPaid(${lesson.id})">Mark Paid</button>` : ''}
                ${(lesson.status === 'pending' || lesson.status === 'overdue') && lesson.student_email !== 'No email provided' ? 
                    `<button class="btn btn-sm btn-warning" onclick="sendReminder(${lesson.id})">Send Reminder</button>` : ''}
                <button class="btn btn-sm btn-danger" onclick="deleteLesson(${lesson.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-GB');
}

function markAsPaid(lessonId) {
    if (!confirm('Mark this lesson as paid?')) return;
    
    fetch(`/api/lesson/${lessonId}/mark_paid`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadLessons();
            // Reload page to update stats
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification(data.error || 'Error updating lesson', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating lesson', 'error');
    });
}

function deleteLesson(lessonId) {
    if (!confirm('Are you sure you want to delete this lesson? This action cannot be undone.')) return;
    
    fetch(`/api/lesson/${lessonId}/delete`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadLessons();
            // Reload page to update stats
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification(data.error || 'Error deleting lesson', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting lesson', 'error');
    });
}

function sendReminder(lessonId) {
    fetch(`/api/send_reminder/${lessonId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Error sending reminder', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending reminder', 'error');
    });
}

function sendBulkReminders() {
    if (!confirm('Send payment reminders to all students with unpaid lessons who have email addresses?')) return;
    
    fetch('/api/send_bulk_reminders', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Error sending reminders', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error sending reminders', 'error');
    });
}

function viewInvoice(lessonId) {
    window.open(`/invoice/${lessonId}`, '_blank');
}
</script>
{% endblock %}