# templates/invoice.html
{% extends "base.html" %}

{% block content %}
<div class="invoice-container">
    <div class="invoice-header">
        <div class="invoice-title">
            <h1>INVOICE</h1>
            <div class="invoice-number">{{ lesson.invoice_number }}</div>
        </div>
        <div class="invoice-date">
            <strong>Date:</strong> {{ lesson.created_at.strftime('%d/%m/%Y') }}
        </div>
    </div>
    
    <div class="invoice-parties">
        <div class="invoice-from">
            <h3>From:</h3>
            <div class="party-details">
                <strong>{{ coach.name }}</strong><br>
                {% if coach.academy_name %}{{ coach.academy_name }}<br>{% endif %}
                <a href="mailto:{{ coach.email }}">{{ coach.email }}</a>
            </div>
        </div>
        <div class="invoice-to">
            <h3>To:</h3>
            <div class="party-details">
                <strong>{{ lesson.student.name }}</strong><br>
                {% if lesson.student.email %}
                    <a href="mailto:{{ lesson.student.email }}">{{ lesson.student.email }}</a><br>
                {% endif %}
                {% if lesson.student.phone %}
                    {{ lesson.student.phone }}
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="invoice-details">
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Duration</th>
                    <th>Rate</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {% if lesson.lesson_type == 'stringing' %}
                            Racquet Stringing Service
                        {% elif lesson.lesson_type == 'individual' %}
                            Individual Tennis Lesson
                        {% elif lesson.lesson_type == 'group' %}
                            Group Tennis Lesson
                        {% elif lesson.lesson_type == 'intensive' %}
                            Intensive Tennis Lesson
                        {% else %}
                            Tennis Lesson - {{ lesson.lesson_type|title }}
                        {% endif %}
                        {% if lesson.notes %}<br><small>{{ lesson.notes }}</small>{% endif %}
                    </td>
                    <td>{{ lesson.date.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if lesson.lesson_type == 'stringing' %}
                            Service
                        {% else %}
                            {{ lesson.duration }}h
                        {% endif %}
                    </td>
                    <td>
                        {% if lesson.lesson_type == 'stringing' %}
                            £{{ "%.2f"|format(lesson.rate) }}
                        {% else %}
                            £{{ "%.2f"|format(lesson.rate) }}/h
                        {% endif %}
                    </td>
                    <td><strong>£{{ "%.2f"|format(lesson.total_amount) }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="invoice-total">
        <div class="total-row">
            <span class="total-label">Total Amount:</span>
            <span class="total-value">£{{ "%.2f"|format(lesson.total_amount) }}</span>
        </div>
        <div class="payment-status status-{{ lesson.status }}">
            Status: {{ lesson.status|title }}
            {% if lesson.paid_at %}
                <br><small>Paid on {{ lesson.paid_at.strftime('%d/%m/%Y') }}</small>
            {% endif %}
        </div>
    </div>
    
    <div class="invoice-footer">
        <div class="payment-terms">
            <h4>Payment Terms:</h4>
            <p>Payment is due within 7 days of the lesson date. Thank you for choosing our tennis coaching services!</p>
        </div>
    </div>
    
    <div class="invoice-actions no-print">
        <button class="btn btn-primary" onclick="window.print()">Print Invoice</button>
        <button class="btn btn-secondary" onclick="window.close()">Close</button>
        {% if lesson.status != 'paid' %}
            <button class="btn btn-success" onclick="markAsPaidFromInvoice({{ lesson.id }})">Mark as Paid</button>
        {% endif %}
    </div>
</div>

<script>
function markAsPaidFromInvoice(lessonId) {
    if (!confirm('Mark this lesson as paid?')) return;
    
    fetch(`/api/lesson/${lessonId}/mark_paid`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Lesson marked as paid successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unable to mark lesson as paid'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating lesson status');
    });
}
</script>
{% endblock %}